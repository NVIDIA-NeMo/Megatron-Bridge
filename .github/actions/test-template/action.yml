# Copyright (c) 2025, NVIDIA CORPORATION. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
name: "Test Template"
description: "Template for running NeMo tests in a containerized environment"

inputs:
  timeout:
    description: "Max runtime of test in minutes"
    required: false
    default: "10"
  script:
    description: "Test script to execute"
    required: true
  is-optional:
    description: "Failure will cancel all other tests if set to true"
    required: false
    default: "false"
  is_unit_test:
    description: "Upload coverage as unit test"
    required: false
    default: "false"
  azure-client-id:
    description: "Azure Client ID"
    required: true
  azure-tenant-id:
    description: "Azure Tenant ID"
    required: true
  azure-subscription-id:
    description: "Azure Subscription ID"
    required: true
  has-azure-credentials:
    description: "Has Azure credentials"
    required: false
    default: "false"
  PAT:
    description: "GitHub Personal Access Token"
    required: true
  container-image:
    description: "Container image to use for test"
    required: true

runs:
  using: "composite"
  steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        path: ${{ github.workspace }}/Megatron-Bridge
        submodules: recursive

    - name: Update MCore submodule (if triggered from MCore)
      if: ${{ github.event.inputs.mcore_commit != '' }}
      shell: bash
      working-directory: ${{ github.workspace }}/Megatron-Bridge
      run: |
        echo "ðŸ”„ Updating MCore submodule to commit: ${{ github.event.inputs.mcore_commit }}"
        cd 3rdparty/Megatron-LM
        git fetch origin ${{ github.event.inputs.mcore_commit }}
        git checkout ${{ github.event.inputs.mcore_commit }}
        
        ACTUAL_COMMIT=$(git rev-parse HEAD)
        echo "âœ… MCore submodule updated to: ${ACTUAL_COMMIT}"
        git log -1 --oneline

    - name: Install Azure CLI
      if: ${{ inputs.has-azure-credentials == 'true' }}
      shell: bash
      run: |
        echo "::group::Install Azure CLI"
        # Create systemd override for proper dependencies
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        echo "::endgroup::"

    - name: Azure Login
      if: ${{ inputs.has-azure-credentials == 'true' }}
      uses: azure/login@v2
      with:
        client-id: ${{ inputs.azure-client-id }}
        tenant-id: ${{ inputs.azure-tenant-id }}
        subscription-id: ${{ inputs.azure-subscription-id }}

    - name: Azure ACR Login
      if: ${{ inputs.has-azure-credentials == 'true' }}
      shell: bash
      run: |
        az acr login --name nemoci

    - name: Start container
      shell: bash
      env:
        MNT_PATH: ${{ steps.azure-fileshare.outputs.MNT_PATH }}
        MOUNT_FS: ${{ inputs.has-azure-credentials == 'true' && inputs.is_unit_test == 'false' }}
      run: |
        echo "::group::Start test container"
        if [[ "$MOUNT_FS" == "true" ]]; then
          VOLUME_ARGS="--volume /mnt/datadrive/TestData:/home/TestData"
        else
          VOLUME_ARGS=""
        fi

        cmd=$(cat <<RUN_TEST_EOF
        #!/bin/bash
        docker container rm -f nemo_container_${{ github.run_id }} || true
        docker run \
          --rm \
          -d \
          --name nemo_container_${{ github.run_id }} \
          --runtime=nvidia --gpus all \
          --shm-size=64g \
          --env TRANSFORMERS_OFFLINE=0 \
          --cpus=40 \
          --env HYDRA_FULL_ERROR=1 \
          --env HF_HOME=/home/TestData/HF_HOME \
          --env NEMO_HOME=/home/TestData/nemo_home \
          --env RUN_ID=${{ github.run_id }} \
          --workdir /opt/Megatron-Bridge \
          --volume ${{ github.workspace }}/Megatron-Bridge:/opt/Megatron-Bridge \
          $VOLUME_ARGS \
          ${{ inputs.container-image }} \
          bash -c "sleep $(( ${{ inputs.timeout }} * 60 + 60 ))"
        RUN_TEST_EOF
        )

        echo "$cmd" | tee "retry_job.sh"
        bash retry_job.sh
        echo "::endgroup::"

    - name: Create run-script
      id: create
      shell: bash
      run: |
        echo "::group::Create run-script"
        COVERAGE_PREFIX=$([[ "${{ inputs.is_unit_test }}" == "true" ]] && echo "unit-test" || echo "e2e")
        echo "coverage-prefix=$COVERAGE_PREFIX" | tee -a "$GITHUB_OUTPUT"

        cmd=$(cat <<'RUN_TEST_EOF'
        #!/bin/bash

        docker exec -t nemo_container_${{ github.run_id }} bash -c '
          set -e
          export GH_TOKEN=${{ inputs.PAT }}
          
          # Reinstall MCore if the submodule was updated
          if [ -n "${{ github.event.inputs.mcore_commit }}" ]; then
            echo "ðŸ”„ Reinstalling MCore from updated submodule..."
            cd /opt/Megatron-Bridge
            
            # Force uninstall existing megatron-core to ensure fresh install
            uv pip uninstall -y megatron-core || true
            
            # Reinstall from the updated submodule
            uv sync --all-extras --all-groups
            echo "âœ… MCore reinstalled"
            
            # Verify the reinstall worked by checking source file hash
            echo "ðŸ” Verifying MCore reinstall..."
            EXPECTED_COMMIT="${{ github.event.inputs.mcore_commit }}"
            VERIFICATION_FAILED=0
            cd 3rdparty/Megatron-LM
            
            # Git metadata check
            ACTUAL_COMMIT=$(git rev-parse HEAD)
            echo "   Expected submodule commit: ${EXPECTED_COMMIT}"
            echo "   Actual submodule commit:   ${ACTUAL_COMMIT}"
            
            # Working directory status
            echo "   Git status check:"
            HAS_CHANGES=0
            if ! git diff-index --quiet HEAD --; then
              echo "   âš ï¸  WARNING: Working directory has uncommitted changes!"
              git status --short
              echo "   Modified files:"
              git diff HEAD --name-only
              HAS_CHANGES=1
            else
              echo "   âœ… Working directory is clean (no uncommitted changes)"
            fi
            
            # Show commit details
            echo "   Git log (last commit):"
            git log -1 --oneline --stat
            
            # Check file hashes at source
            echo "   Source file hashes (from working directory):"
            for file in megatron/core/__init__.py megatron/core/package_info.py pyproject.toml; do
              if [ -f "${file}" ]; then
                HASH=$(sha256sum "${file}" | awk '\''{print substr($1,1,16)}'\'')
                FULL_HASH=$(sha256sum "${file}" | awk '\''{print $1}'\'')
                echo "     ${file}: ${HASH}... (full: ${FULL_HASH})"
              fi
            done
            
            cd /opt/Megatron-Bridge
            
            # Also verify the INSTALLED package matches the source
            echo "ðŸ” Verifying installed megatron-core package..."
            SOURCE_HASH=$(sha256sum 3rdparty/Megatron-LM/megatron/core/__init__.py | awk '\''{print substr($1,1,16)}'\'')
            SOURCE_FULL_HASH=$(sha256sum 3rdparty/Megatron-LM/megatron/core/__init__.py | awk '\''{print $1}'\'')
            echo "import megatron.core; print(megatron.core.__file__)" > /tmp/check_mcore.py
            INSTALLED_PATH=$(uv run python /tmp/check_mcore.py | tr -d '\''\r'\'' | tail -1)
            HASH_MISMATCH=0
            if [ -f "${INSTALLED_PATH}" ]; then
              INSTALLED_HASH=$(sha256sum "${INSTALLED_PATH}" | awk '\''{print substr($1,1,16)}'\'')
              INSTALLED_FULL_HASH=$(sha256sum "${INSTALLED_PATH}" | awk '\''{print $1}'\'')
              echo "   Source __init__.py hash:    ${SOURCE_HASH} (full: ${SOURCE_FULL_HASH})"
              echo "   Installed __init__.py hash: ${INSTALLED_HASH} (full: ${INSTALLED_FULL_HASH})"
              echo "   Installed location:         ${INSTALLED_PATH}"
              
              if [ "${SOURCE_HASH}" != "${INSTALLED_HASH}" ]; then
                echo "   âŒ Hash mismatch detected!"
                echo "   Source file size:    $(stat -f%z 3rdparty/Megatron-LM/megatron/core/__init__.py 2>/dev/null || stat -c%s 3rdparty/Megatron-LM/megatron/core/__init__.py 2>/dev/null) bytes"
                echo "   Installed file size: $(stat -f%z ${INSTALLED_PATH} 2>/dev/null || stat -c%s ${INSTALLED_PATH} 2>/dev/null) bytes"
                HASH_MISMATCH=1
              else
                echo "   âœ… Installed package matches source (hashes match perfectly)"
              fi
            else
              echo "   âš ï¸  Warning: Could not verify installed package location"
            fi
            rm -f /tmp/check_mcore.py
            
            # Now check for errors after collecting ALL diagnostics
            echo ""
            echo "ðŸ“Š Verification Summary:"
            if [ "${ACTUAL_COMMIT}" != "${EXPECTED_COMMIT}" ]; then
              echo "   âŒ ERROR: Submodule commit mismatch after checkout!"
              VERIFICATION_FAILED=1
            fi
            
            if [ "${HAS_CHANGES}" -eq 1 ]; then
              echo "   âŒ ERROR: Working directory is dirty - this will cause hash mismatches!"
              VERIFICATION_FAILED=1
            fi
            
            if [ "${HASH_MISMATCH}" -eq 1 ]; then
              echo "   âŒ ERROR: Installed package does not match source!"
              echo "      Diagnosis: uv sync did not reinstall from updated submodule"
              VERIFICATION_FAILED=1
            fi
            
            if [ "${VERIFICATION_FAILED}" -eq 1 ]; then
              echo ""
              echo "âŒ MCore verification FAILED. See diagnostics above."
              exit 1
            fi
            
            echo "   âœ… All MCore verifications passed!"
            
            # Store commit SHA for verification (since Docker build file was overridden by volume mount)
            echo "${{ github.event.inputs.mcore_commit }}" > /opt/Megatron-Bridge/.mcore_commit_sha
            echo "ðŸ“ Stored MCore commit SHA: ${{ github.event.inputs.mcore_commit }}"
          fi
          
          timeout $(( ${{ inputs.timeout }} * 60 ))s bash tests/${{ inputs.is_unit_test == 'true' && 'unit_tests' || 'functional_tests' }}/${{ inputs.script }}.sh || EXIT_CODE=$?

          if [[ "$EXIT_CODE" -eq 124 ]]; then
            echo "::error:: Test timed out after ${{ inputs.timeout }} minutes. Please reach out to the PIC."
          fi

          exit $EXIT_CODE
        '

        RUN_TEST_EOF
        )

        echo "timeout_in_seconds=$(( ${{ inputs.timeout }} * 60 ))" | tee -a "$GITHUB_OUTPUT"
        echo "$cmd" | tee "job.sh"
        echo "::endgroup::"

    - name: Run main script
      shell: bash
      run: /bin/bash job.sh

    - name: Check result
      id: check
      shell: bash
      run: |
        echo "::group::Check result"

        docker exec nemo_container_${{ github.run_id }} /opt/venv/bin/coverage combine || true
        docker exec nemo_container_${{ github.run_id }} /opt/venv/bin/coverage xml
        docker cp nemo_container_${{ github.run_id }}:/opt/Megatron-Bridge/.coverage .coverage
        docker cp nemo_container_${{ github.run_id }}:/opt/Megatron-Bridge/coverage.xml coverage.xml

        coverage_report=coverage-${{ steps.create.outputs.coverage-prefix }}-${{ github.run_id }}-$(uuidgen)
        echo "coverage_report=$coverage_report" >> "$GITHUB_OUTPUT"

        EXIT_CODE=${{ steps.run-main-script.outputs.exit_code }}
        IS_SUCCESS=$([[ "$EXIT_CODE" -eq 0 ]] && echo "true" || echo "false")

        if [[ "$IS_SUCCESS" == "false" && "${{ inputs.is-optional }}" == "true" ]]; then
          echo "::warning:: Test failed, but displayed as successful because it is marked as optional."
          IS_SUCCESS=true
        fi

        if [[ "$IS_SUCCESS" == "false" ]]; then
          echo Test did not finish successfully.
          exit 1
        else
          docker exec -t nemo_container_${{ github.run_id }} /opt/venv/bin/coverage report -i
        fi

        exit $EXIT_CODE
        echo "::endgroup::"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: ${{ steps.check.outputs.coverage_report != 'none' }}
      with:
        name: ${{ steps.check.outputs.coverage_report }}
        path: |
          coverage.xml
          .coverage
        include-hidden-files: true

    - name: Container shutdown
      if: always()
      shell: bash
      run: |
        docker container rm -f nemo_container_${{ github.run_id }} || true
